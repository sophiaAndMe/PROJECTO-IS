<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - El Buen Sabor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .badge-pendiente { background-color: #ffc107; color: dark; }
        .badge-confirmada { background-color: #28a745; }
        .badge-cancelada { background-color: #dc3545; }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark mb-4 shadow-sm">
    <div class="container">
        <span class="navbar-brand mb-0 h1">üçΩÔ∏è El Buen Sabor - Gesti√≥n Administrativa</span>
        <a href="/reserva" class="btn btn-outline-light btn-sm">Ir a Formulario</a>
    </div>
</nav>

<div class="container">
    <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3">
            <h3 class="card-title mb-0 text-primary">Gesti√≥n de Reservas (HU-02)</h3>
            <p class="text-muted small mb-0">Visualizaci√≥n ordenada por fecha y hora (RF-04)</p>
        </div>
        <div class="card-body">
            
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>ID Reserva</th>
                            <th>Cliente</th>
                            <th>Fecha</th>
                            <th>Hora</th>
                            <th>Mesa</th>
                            <th>Estado</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="reserva : ${reservas}">
                            <td>
                                <code class="small text-truncate d-inline-block" style="max-width: 100px;" 
                                      th:text="${reserva.reservaId}" th:title="${reserva.reservaId}"></code>
                            </td>
                            <td>
                                <div class="fw-bold" th:text="${reserva.cliente.nombre}"></div>
                                <div class="small text-muted" th:text="${reserva.cliente.email}"></div>
                            </td>
                            <td th:text="${reserva.fechaReserva}"></td>
                            <td th:text="${reserva.horaReserva}"></td>
                            <td>
                                <span class="badge bg-info text-dark" th:text="'Mesa ' + ${reserva.mesa.numeroMesa}"></span>
                            </td>
                            <td>
                                <span class="badge" 
                                      th:classappend="${reserva.estadoReserva == 'PENDIENTE' ? 'bg-warning text-dark' : 
                                                       (reserva.estadoReserva == 'CONFIRMADA' ? 'bg-success' : 'bg-danger')}"
                                      th:text="${reserva.estadoReserva}">
                                </span>
                            </td>
                            <td class="text-center">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-success btn-estado" 
                                            th:data-id="${reserva.reservaId}" 
                                            data-nuevo-estado="CONFIRMADA"
                                            th:disabled="${reserva.estadoReserva == 'CONFIRMADA'}">
                                        Confirmar
                                    </button>
                                    <button class="btn btn-sm btn-danger btn-estado" 
                                            th:data-id="${reserva.reservaId}" 
                                            data-nuevo-estado="CANCELADA"
                                            th:disabled="${reserva.estadoReserva == 'CANCELADA'}">
                                        Cancelar
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(reservas)}">
                            <td colspan="7" class="text-center py-4 text-muted">
                                No hay reservas registradas actualmente.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div> </div>
    </div>
    
    <footer class="mt-5 py-3 text-center text-muted">
        <small>&copy; 2026 Restaurante El Buen Sabor - Panel de Control</small>
    </footer>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // Listener para los botones de cambio de estado
        document.querySelectorAll('.btn-estado').forEach(boton => {
            boton.addEventListener('click', async (e) => {
                // Captura de datos desde los atributos personalizados
                const id = e.target.getAttribute('data-id');
                const estado = e.target.getAttribute('data-nuevo-estado');

                if (!confirm(`¬øDeseas marcar la reserva como ${estado}?`)) return;

                try {
                    // PATCH al endpoint unificado con soporte para UUID (String)
                    const response = await fetch(`/api/reservas/${id}/estado?nuevoEstado=${estado}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        alert("‚úÖ Estado actualizado correctamente.");
                        location.reload(); // Recarga para ver cambios y re-ordenamiento
                    } else {
                        const errorMsg = await response.text();
                        alert("‚ùå Error: " + errorMsg);
                    }
                } catch (error) {
                    console.error("Fallo de red:", error);
                    alert("‚ùå Error de conexi√≥n con el servidor.");
                }
            });
        });
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>