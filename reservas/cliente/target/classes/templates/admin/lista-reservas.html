<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Panel Admin - El Buen Sabor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container">
        <span class="navbar-brand">Administración - El Buen Sabor</span>
    </div>
</nav>

<div class="container">
    <div class="card shadow">
        <div class="card-header bg-white">
            <h3 class="mb-0">Gestión de Reservas (HU-02)</h3>
        </div>
        <div class="card-body">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Cliente (RF-02)</th>
                        <th>Fecha</th>
                        <th>Hora</th>
                        <th>Mesa</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="reserva : ${reservas}">
                        <td th:text="${reserva.reservaId}"></td>
                        <td>
                            <strong th:text="${reserva.cliente.nombre}"></strong><br>
                            <small class="text-muted" th:text="${reserva.cliente.email}"></small>
                        </td>
                        <td th:text="${reserva.fechaReserva}"></td>
                        <td th:text="${reserva.horaReserva}"></td>
                        <td th:text="'Mesa ' + ${reserva.mesa.numeroMesa}"></td>
                        <td>
                            <span class="badge" 
                                  th:classappend="${reserva.estadoReserva == 'PENDIENTE' ? 'bg-warning' : 'bg-success'}"
                                  th:text="${reserva.estadoReserva}">
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-success btn-estado" 
                                th:data-id="${reserva.reservaId}" 
                                data-nuevo-estado="CONFIRMADA">
                                Confirmar
                            </button>

                            <button class="btn btn-sm btn-danger btn-estado" 
                                 th:data-id="${reserva.reservaId}" 
                                data-nuevo-estado="CANCELADA">
                                Cancelar
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>

    document.addEventListener('DOMContentLoaded', () => {
    // Buscamos todos los botones que tengan la clase 'btn-estado'
    document.querySelectorAll('.btn-estado').forEach(boton => {
        boton.addEventListener('click', async (e) => {
            const id = e.target.getAttribute('data-id');
            const estado = e.target.getAttribute('data-nuevo-estado');

            if (!confirm(`¿Seguro que deseas cambiar el estado a ${estado}?`)) return;

            try {
                // Llamada al API que creamos en el ReservaController
                const response = await fetch(`/api/reservas/${id}/estado?nuevoEstado=${estado}`, {
                    method: 'PATCH'
                });

                if (response.ok) {
                    alert("✅ ¡Estado actualizado!");
                    location.reload(); // Recarga para ver el cambio
                } else {
                    alert("❌ Error al procesar la solicitud.");
                }
            } catch (error) {
                console.error("Error:", error);
                alert("❌ Fallo de conexión con el servidor.");
            }
        });
    });
});

</script>
</body>
</html>