<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Reserva - El Buen Sabor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #timer { font-weight: bold; color: red; }
    </style>
</head>
<body class="bg-light">
<div class="container mt-5">
    <div class="card shadow p-4 mx-auto" style="max-width: 500px;">
        <h2 class="text-center mb-4">Reservar Mesa</h2>
        

        
        <div class="alert alert-warning text-center">
            ¡Date prisa! La mesa se liberará en: <span id="timer">30</span>s
        </div>

        <form id="reservaForm">
            <div class="mb-3">
                <label>Nombre Completo (RF-02):</label>
                <input type="text" id="nombreCliente" class="form-control" required>
            </div>
            <div class="mb-3">
                <label>Email:</label>
                <input type="email" id="email" class="form-control" required>
            </div>
            <div class="mb-3">
                <label>Teléfono:</label>
                <input type="text" id="telefono" class="form-control" required>
            </div>
            <div class="row">
                
                <div class="col-md-6 mb-3">
                    <label>Selecciona tu Mesa (Disponibles):</label>
                        <select id="mesaId" class="form-select" required disabled>
                            <option value="">Primero elige fecha/hora...</option>
                        </select>
                    <small id="statusBusqueda" class="text-muted"></small>
                </div>

                <div class="col-md-6 mb-3">
                    <label>Personas (RF-06):</label>
                    <input type="number" id="numeroComensales" class="form-control" value="2" required>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label>Fecha:</label>
                    <input type="date" id="fecha" class="form-control" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label>Hora:</label>
                    <input type="time" id="hora" class="form-control" required>
                </div>
            </div>
            <button type="submit" id="btnReservar" class="btn btn-primary w-100">Confirmar Reserva</button>
        </form>
    </div>
</div>

<script>
    // Lógica del Temporizador (30 segundos de realismo)
    let timeLeft = 120;
    const timerElement = document.getElementById('timer');
    const form = document.getElementById('reservaForm');
    const fechaInput = document.getElementById('fecha');
    const horaInput = document.getElementById('hora');
    const comensalesInput = document.getElementById('numeroComensales');
    const mesaSelect = document.getElementById('mesaId');
    const statusBusqueda = document.getElementById('statusBusqueda');
    const countdown = setInterval(() => {
        timeLeft--;
        timerElement.innerText = timeLeft;
        if (timeLeft <= 0) {
            clearInterval(countdown);
            alert("El tiempo de reserva ha expirado. La mesa ha sido liberada.");
            location.reload(); // Recarga para limpiar
        }
    }, 1000);


    // Función para buscar mesas en tiempo real (RNF-02: Respuesta rápida)
    async function actualizarMesas() {
        const fecha = fechaInput.value;
        const hora = horaInput.value;
        const comensales = comensalesInput.value;

        if (fecha && hora && comensales) {
            statusBusqueda.innerText = "Buscando mesas...";
            try {
                const response = await fetch(`/api/reservas/disponibilidad?fecha=${fecha}&hora=${hora}:00&comensales=${comensales}`);
                
                if (response.ok) {
                    const mesas = await response.json();
                    mesaSelect.innerHTML = '<option value="">-- Elige una mesa --</option>';
                    mesas.forEach(m => {
                        mesaSelect.innerHTML += `<option value="${m.mesaId}">Mesa ${m.numeroMesa} (Cap: ${m.capacidadMesa} - ${m.ubicacion})</option>`;
                    });
                    mesaSelect.disabled = false;
                    statusBusqueda.innerText = "✅ Mesas encontradas.";
                } else {
                    const error = await response.text();
                    mesaSelect.innerHTML = '<option value="">No hay disponibilidad</option>';
                    mesaSelect.disabled = true;
                    statusBusqueda.innerText = "❌ " + error;
                }
            } catch (err) {
                console.error("Error en la consulta:", err);
            }
        }
    }

    // Escuchar cambios para actualizar la disponibilidad automáticamente
    [fechaInput, horaInput, comensalesInput].forEach(input => {
        input.addEventListener('change', actualizarMesas);
    });

    // Envío de datos al RestController que ya tienes
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        clearInterval(countdown); // Detener el reloj al enviar

        // En tu formulario-reserva.html
    const data = {
    nombreCliente: document.getElementById('nombreCliente').value,
    email: document.getElementById('email').value,
    telefono: document.getElementById('telefono').value,
    mesaId: document.getElementById('mesaId').value, // ENVIAR COMO STRING DIRECTO
    fecha: document.getElementById('fecha').value,
    hora: document.getElementById('hora').value + ":00",
    numeroComensales: document.getElementById('numeroComensales').value
    };

        // Log para que tú mismo veas si el ID es nulo antes de enviarlo
        console.log("Enviando datos:", data);

        const response = await fetch('/api/reservas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            alert("✅ ¡Reserva Exitosa!");
            window.location.href = "/";
        } else {
            alert("❌ Error al reservar. Revisa la consola.");
        }
    });
</script>
</body>
</html>